<!DOCTYPE html>

<html>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TE4</title>
  <link rel="stylesheet" href="http://infotavla.te4projekt.se/css/main.css" />
  <script src="http://infotavla.te4projekt.se/scripts/clockAndDate.js"></script>
  <style type="text/css">
    .page {
      position: absolute;
      width: 100%;
      /*scale: 3;*/
    }
  </style>
  <script type="text/javascript">
    const fade = [
      { opacity: "100%", zIndex: "1" },
      { opacity: "0%", zIndex: "1" },
    ];
    const appear = [{ opacity: "100%", zIndex: "0" }];
    const disappear = [{ opacity: "0%", zIndex: "-1" }];

    let templateElements = null;
    let info = {
      templates: []
    };
    let changed = false;
    let counter = 0;
    let currentIndex = 0;
    const source = new EventSource("events");

    source.addEventListener("message", (message) => {
      console.log(JSON.stringify(message.data))
      if (info != message.data) {
        console.log("got new stuff!");
        changed = true;
        info = message.data;
        document.getElementById('page-container').innerHTML = info.templates.reduce((prev, curr) => (prev + curr.html), '');
        templateElements = document.getElementsByClassName("page");
      }
    });

    setInterval(() => {
      if (templateElements) {
        counter += 1000;
        if (changed) {
          console.log("stuff changed! changed!");
          changed = false;
          templateElements[currentIndex].style.opacity = "100%";
          for (let index = 0; index < templateElements.length; index++) {
            if (index != currentIndex) {
              templateElements[index].style.opacity = "0%";
            }
          }
        }
        if (templateElements.length > 1) {
          if (counter <= (info.templates[currentIndex].duration * 1000)) {
            counter = 0;
            for (let index = 0; index < templateElements.length; index++) {
              if (index !== currentIndex || index !== (currentIndex + 1) % templateElements.length) {
                templateElements[index].animate(disappear, {
                  duration: 0,
                  iterations: 1,
                  fill: "forwards",
                });
              }
            }
            console.log(`Changing from ${currentIndex} to ${(currentIndex + 1) % templateElements.length}`);

            templateElements[(currentIndex + 1) % templateElements.length].animate(appear, {
              duration: 0,
              iterations: 1,
              fill: "forwards",
            });

            templateElements[currentIndex].animate(fade, {
              duration: 0,
              iterations: 1,
              fill: "forwards",
            });
            currentIndex = (currentIndex + 1) % templateElements.length;
          }
        }
      }
    }, 1000);
  </script>
</head>

<body onload="InitClock()">
  <div id="page-container"></div>
  <div id="ww_c2119b56c9599" v='1.3' loc='id'
    a='{"t":"ticker","lang":"en","ids":["wl2618"],"font":"Arial","sl_ics":"one","sl_sot":"celsius","cl_bkg":"#7B1FA2","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722","el_nme":3}'>
    <a href="https://sharpweather.com/widgets/" id="ww_c2119b56c9599_u" target="_blank">
      Free HTML Weather Widget for Website
    </a>
  </div>
  <script async src="http://infotavla.te4projekt.se/scripts/weatherWidget.js"></script>
</body>

</html>